<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>archi — Service Status Board</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='chat.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='data.css') }}">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/archi_notext.png') }}">
  <style>
    /* ── Layout ──────────────────────────────────────────────────── */
    .ssb-content {
      flex: 1;
      overflow-y: auto;
      padding: 24px 20px;
    }
    .ssb-inner {
      max-width: 820px;
      margin: 0 auto;
    }

    /* ── Section heading ──────────────────────────────────────────── */
    .ssb-section-title {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted, #6e7681);
      margin: 28px 0 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border-color, #30363d);
    }
    .ssb-section-title:first-child { margin-top: 0; }

    /* ── Alert card ───────────────────────────────────────────────── */
    .alert-card {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      background: var(--bg-secondary, #161b22);
      border: 1px solid var(--border-color, #30363d);
      border-radius: 8px;
      padding: 14px 16px;
      margin-bottom: 8px;
      transition: border-color 0.15s ease;
    }
    .alert-card:hover { border-color: var(--text-muted, #6e7681); }
    .alert-card.expired { opacity: 0.45; }

    .alert-body { flex: 1; min-width: 0; }
    .alert-message {
      font-weight: 500;
      color: var(--text-primary, #e6edf3);
      font-size: 14px;
      margin-bottom: 3px;
    }
    .alert-description {
      font-size: 13px;
      color: var(--text-secondary, #8b949e);
      margin-bottom: 6px;
    }
    .alert-meta {
      font-size: 12px;
      color: var(--text-muted, #6e7681);
      display: flex;
      flex-wrap: wrap;
      gap: 0 6px;
    }
    .alert-meta-sep { color: var(--text-muted, #6e7681); }

    /* ── Severity badge ───────────────────────────────────────────── */
    .badge {
      display: inline-flex;
      align-items: center;
      border-radius: 4px;
      padding: 2px 7px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      white-space: nowrap;
      flex-shrink: 0;
      margin-top: 2px;
    }
    .badge-alarm   { background: rgba(220,38,38,0.18);  color: #fca5a5; border: 1px solid rgba(220,38,38,0.35); }
    .badge-warning { background: rgba(217,119,6,0.18);  color: #fcd34d; border: 1px solid rgba(217,119,6,0.35); }
    .badge-info    { background: rgba(59,130,246,0.15); color: #93c5fd; border: 1px solid rgba(59,130,246,0.3); }
    .badge-news    { background: rgba(16,185,129,0.15); color: #6ee7b7; border: 1px solid rgba(16,185,129,0.3); }

    /* ── Delete button ────────────────────────────────────────────── */
    .btn-danger {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 5px 10px;
      font-size: 12px;
      font-family: inherit;
      border-radius: 6px;
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
      background: transparent;
      color: var(--text-secondary, #8b949e);
      border: 1px solid var(--border-color, #30363d);
      transition: all 0.15s ease;
    }
    .btn-danger:hover {
      color: #fca5a5;
      border-color: rgba(220,38,38,0.5);
      background: rgba(220,38,38,0.1);
    }

    /* ── Post Alert form ──────────────────────────────────────────── */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      font-size: 13px;
      font-family: inherit;
      font-weight: 500;
      border-radius: 6px;
      cursor: pointer;
      border: none;
      transition: all 0.15s ease;
    }
    .btn-primary {
      background: var(--accent-color, #58a6ff);
      color: #fff;
    }
    .btn-primary:hover { background: #79b8ff; }

    .form-card {
      background: var(--bg-secondary, #161b22);
      border: 1px solid var(--border-color, #30363d);
      border-radius: 8px;
      padding: 20px;
    }
    .form-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .form-group label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary, #8b949e);
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      background: var(--bg-tertiary, #21262d);
      border: 1px solid var(--border-color, #30363d);
      border-radius: 6px;
      color: var(--text-primary, #e6edf3);
      padding: 6px 10px;
      font-family: inherit;
      font-size: 13px;
      transition: border-color 0.15s ease;
    }
    .form-group select option { background: var(--bg-tertiary, #21262d); }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent-color, #58a6ff);
    }
    .form-group textarea { resize: vertical; min-height: 70px; }
    .form-actions { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .form-msg { font-size: 12px; display: none; }
    .form-msg.error   { color: #f87171; }
    .form-msg.success { color: #34d399; }

    /* ── Empty state ──────────────────────────────────────────────── */
    .ssb-empty {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-muted, #6e7681);
      font-size: 13px;
      padding: 12px 0;
    }
    .ssb-empty svg { flex-shrink: 0; }
  </style>
</head>
<body>
{% include '_alert_banner.html' %}
<div class="data-app">

  <!-- Header -->
  <header class="data-header">
    <div class="header-left">
      <a href="/chat" class="back-link" title="Back to Chat">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"></path>
        </svg>
        <span>Chat</span>
      </a>
    </div>
    <div class="header-center">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="header-icon">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
      <h1>Service Status Board</h1>
    </div>
    <div class="header-right"></div>
  </header>

  <!-- Content -->
  <div class="ssb-content">
    <div class="ssb-inner">

      <!-- Active alerts -->
      <div class="ssb-section-title">Active Alerts</div>
      {% set active_alerts = alerts | selectattr('active') | selectattr('expired', 'equalto', false) | list %}
      {% if active_alerts %}
        {% for alert in active_alerts %}
        <div class="alert-card" id="card-{{ alert.id }}">
          <span class="badge badge-{{ alert.severity }}">{{ alert.severity }}</span>
          <div class="alert-body">
            <div class="alert-message">{{ alert.message }}</div>
            {% if alert.description %}
            <div class="alert-description">{{ alert.description }}</div>
            {% endif %}
            <div class="alert-meta">
              {% if alert.created_by %}<span>{{ alert.created_by }}</span><span class="alert-meta-sep">·</span>{% endif %}
              <span>{{ alert.created_at.strftime('%Y-%m-%d %H:%M UTC') if alert.created_at else '' }}</span>
              {% if alert.expires_at %}<span class="alert-meta-sep">·</span><span>expires {{ alert.expires_at.strftime('%Y-%m-%d %H:%M UTC') }}</span>{% endif %}
            </div>
          </div>
          {% if is_alert_manager %}
          <button class="btn-danger" onclick="deleteAlert({{ alert.id }})">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6l-1 14H6L5 6"></path>
              <path d="M10 11v6M14 11v6"></path>
            </svg>
            Delete
          </button>
          {% endif %}
        </div>
        {% endfor %}
      {% else %}
        <div class="ssb-empty">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
          All systems operational — no active alerts.
        </div>
      {% endif %}

      <!-- Expired / historical -->
      {% set expired_alerts = alerts | selectattr('expired') | list %}
      {% if expired_alerts %}
      <div class="ssb-section-title">Expired Alerts</div>
      {% for alert in expired_alerts %}
      <div class="alert-card expired" id="card-{{ alert.id }}">
        <span class="badge badge-{{ alert.severity }}">{{ alert.severity }}</span>
        <div class="alert-body">
          <div class="alert-message">{{ alert.message }}</div>
          {% if alert.description %}
          <div class="alert-description">{{ alert.description }}</div>
          {% endif %}
          <div class="alert-meta">
            {% if alert.created_by %}<span>{{ alert.created_by }}</span><span class="alert-meta-sep">·</span>{% endif %}
            <span>{{ alert.created_at.strftime('%Y-%m-%d %H:%M UTC') if alert.created_at else '' }}</span>
            <span class="alert-meta-sep">·</span><span>expired</span>
          </div>
        </div>
        {% if is_alert_manager %}
        <button class="btn-danger" onclick="deleteAlert({{ alert.id }})">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6l-1 14H6L5 6"></path>
            <path d="M10 11v6M14 11v6"></path>
          </svg>
          Delete
        </button>
        {% endif %}
      </div>
      {% endfor %}
      {% endif %}

      <!-- Post new alert (managers only) -->
      {% if is_alert_manager %}
      <div class="ssb-section-title">Post New Alert</div>
      <div class="form-card">
        <div class="form-row">
          <div class="form-group" style="flex:2;min-width:200px;">
            <label for="f-message">Message <span style="color:#f87171">*</span></label>
            <input type="text" id="f-message" placeholder="Short banner text" maxlength="200">
          </div>
          <div class="form-group" style="min-width:120px;">
            <label for="f-severity">Severity</label>
            <select id="f-severity">
              <option value="info">info</option>
              <option value="warning">warning</option>
              <option value="alarm">alarm</option>
              <option value="news">news</option>
            </select>
          </div>
          <div class="form-group" style="min-width:200px;">
            <label for="f-expires-at">Expires at <span style="color:var(--text-muted,#6e7681)">(optional)</span></label>
            <input type="datetime-local" id="f-expires-at">
          </div>
        </div>
        <div class="form-group" style="margin-bottom:16px;">
          <label for="f-description">Description <span style="color:var(--text-muted,#6e7681)">(optional)</span></label>
          <textarea id="f-description" placeholder="Longer details shown on the status board"></textarea>
        </div>
        <div class="form-actions">
          <button class="btn btn-primary" onclick="createAlert()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Post Alert
          </button>
          <span id="form-error" class="form-msg error"></span>
          <span id="form-success" class="form-msg success"></span>
        </div>
      </div>
      {% endif %}

    </div>
  </div><!-- .ssb-content -->

</div><!-- .data-app -->

<script>
// Set the minimum selectable datetime to right now
(function() {
  var inp = document.getElementById('f-expires-at');
  if (inp) {
    var now = new Date();
    now.setSeconds(0, 0);
    // datetime-local requires YYYY-MM-DDTHH:MM format
    inp.min = now.toISOString().slice(0, 16);
  }
})();

function deleteAlert(id) {
  if (!confirm('Delete this alert?')) return;
  fetch('/api/ssb/alerts/' + id, { method: 'DELETE' })
    .then(function(r){ return r.json(); })
    .then(function(data){
      if (data.deleted) {
        var el = document.getElementById('card-' + id);
        if (el) el.remove();
      }
    })
    .catch(function(e){ alert('Error: ' + e); });
}

function createAlert() {
  var message     = document.getElementById('f-message').value.trim();
  var severity    = document.getElementById('f-severity').value;
  var description = document.getElementById('f-description').value.trim();
  var expiresAt  = document.getElementById('f-expires-at').value;
  var errEl = document.getElementById('form-error');
  var okEl  = document.getElementById('form-success');
  errEl.style.display = 'none';
  okEl.style.display  = 'none';

  if (!message) {
    errEl.textContent = 'Message is required.';
    errEl.style.display = 'inline';
    return;
  }

  if (expiresAt && new Date(expiresAt) <= new Date()) {
    errEl.textContent = 'Expiry date/time must be in the future.';
    errEl.style.display = 'inline';
    return;
  }

  var body = { severity: severity, message: message };
  if (description) body.description = description;
  if (expiresAt)   body.expires_at = expiresAt;  // ISO-8601 local datetime string

  fetch('/api/ssb/alerts', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  })
  .then(function(r){ return r.json().then(function(d){ return { ok: r.ok, data: d }; }); })
  .then(function(res){
    if (!res.ok) {
      errEl.textContent   = res.data.error || 'Failed to create alert.';
      errEl.style.display = 'inline';
    } else {
      okEl.textContent   = 'Alert posted — reload to see it in the list.';
      okEl.style.display = 'inline';
      document.getElementById('f-message').value     = '';
      document.getElementById('f-description').value = '';
      document.getElementById('f-expires-at').value  = '';
    }
  })
  .catch(function(e){ errEl.textContent = 'Request failed: ' + e; errEl.style.display = 'inline'; });
}
</script>
</body>
</html>
